
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .filter-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 300px;
    }
    .filter-panel label { display: block; margin-top: 8px; }
  </style>
</head>
<body>
<div class="filter-panel">
  <label for="distanceFilter">Distance (km) :</label>
  <input type="range" id="distanceFilter" min="10" max="100" value="30" step="10" oninput="updateDistanceFilter(this.value)">
  <span id="distanceLabel">30</span> km

  <label>Filtrer par corps de métier :</label>
  <div id="metierFilters"></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([46.5, 4.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let referencePoint = L.latLng(46.5, 4.5);
let referenceCircle = L.circle(referencePoint, {
  radius: 30000,
  color: '#ff0000',
  fillColor: '#f03',
  fillOpacity: 0.1
}).addTo(map);
let currentRadius = 30000;
let markers = [];

const colorMap = {
  "Plomberie": "blue",
  "Électricien": "green",
  "Carreleur": "orange",
  "Plaquiste": "purple",
  "Menuisier": "yellow",
  "Tout corps d'état": "red"
};

function getIconForMetier(metier) {
  const color = colorMap[metier] || "gray";
  return L.icon({
    iconUrl: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });
}

function addMarker(data) {
  const { Nom, Adresse, Métier, Contact, Label, lat, lon } = data;
  const point = L.latLng(lat, lon);
  const marker = L.marker(point, { icon: getIconForMetier(Métier) }).bindPopup(
    `<b>${Nom}</b><br>${Adresse}<br><i>${Métier}</i><br>${Contact}<br>${Label}`
  );
  marker._rawData = data;
  markers.push(marker);
}

function updateFilters() {
  const selectedMetiers = Array.from(document.querySelectorAll('.metier-filter:checked')).map(cb => cb.value);
  markers.forEach(marker => {
    const data = marker._rawData;
    const dist = referencePoint.distanceTo(marker.getLatLng());
    const visible = dist <= currentRadius && selectedMetiers.includes(data.Métier);
    if (visible) {
      marker.addTo(map);
    } else {
      map.removeLayer(marker);
    }
  });
  if (referenceCircle) {
    referenceCircle.setRadius(currentRadius);
  }
}

function updateDistanceFilter(km) {
  document.getElementById('distanceLabel').innerText = km;
  currentRadius = km * 1000;
  updateFilters();
}

function updateMetierFilters(metiers) {
  const container = document.getElementById("metierFilters");
  container.innerHTML = "";
  metiers.forEach(m => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" class="metier-filter" value="${m}" checked> ${m}`;
    container.appendChild(label);
    container.appendChild(document.createElement("br"));
  });
  document.querySelectorAll('.metier-filter').forEach(cb => cb.addEventListener('change', updateFilters));
}

fetch("entreprises.json")
  .then(response => response.json())
  .then(data => {
    const metiersSet = new Set();
    data.forEach(entry => {
      addMarker(entry);
      metiersSet.add(entry.Métier);
    });
    updateMetierFilters([...metiersSet]);
    updateFilters();
  });
</script>
</body>
</html>
